 <html>                                                                  
 <head>                                                                  
 <script type="text/javascript" src="jquery-1.4.2.min.js"></script>
 <script type="text/javascript" src="jquery-ui-1.8.2.custom.min.js"></script>    
 <script type="text/javascript" src="jquery.url.packed.js"></script>  
 <script type="text/javascript" src="urlEncode.js"></script> 
 <link rel="stylesheet" type="text/css" href="jquery-ui-1.8.2.custom.css"/>
 <link rel="stylesheet" type="text/css" href="main.css"/>
       
 <script type="text/javascript">                                         
   // we will add our javascript code here
   $(document).ready(function() {
   $pageCountResults = 20;
   $solrUrl = "http://seqcrawler.genouest.org/solr/select?rows="+$pageCountResults+"&qt=shard&wt=json&";
   $solrFacet ="facet=on&facet.field=bank&";
   $storageurl = "http://seqcrawler.genouest.org";
   $gburl = "http://seqcrawler.genouest.org";
   $gbbank = "genouest";
   
   $pageCount=1;
   
   $("#metadata").ajaxError(function(event, request, settings){
   $("#documentDetails" ).dialog( "close" );
   $(this).html("<b><li>Error requesting page " + settings.url + "</li></b>");
   });  
   });
   
   
    $(function() { 
    $("#documentDetails").hide();
    $('.error').hide(); 
    
     
    $(".button").click(function() { 
     $('.error').hide();
     var queryField = $("input#query").val();  
     if (queryField == "") {  
       $("label#query_error").show();  
       $("input#query").focus();  
       return false;  
     }   

     doQuery(queryField,0);
     return false;
   });  
   }); 
   
   
   function appendField(fieldname) {
   
   $("input#query").val($("input#query").val()+" "+fieldname+":");
   
   }
   
   function showFields() {
   		$.get("fields.txt",
				   function(data){
				   var result = jQuery.parseJSON(data);
				   var fields = result["fields"];
				   var fieldlist = "";
				   for(var field in fields) {
				   	fieldlist += "<p onclick=\"appendField('"+fields[field]+"')\">"+fields[field]+"</p>";
				   }
				   $("#documentDetails" ).html(fieldlist);
				   $("#documentDetails" ).dialog({ title: 'List of available fields' , width : '300px' });
				   
		});
   }
   
   function goToPage() {
		$("#documentDetails" ).html('<p class="wait"><img title="loading" alt="loading" src="images/waiting.gif"/></p>');
	 	$("#documentDetails" ).dialog({ title: 'Loading, please wait' , width : '200px'  });
   		if($("#gotopage").val()!="") {
   			doQuery($("input#query").val(),($("#gotopage").val() - 1) * $pageCountResults);
   		}
   }
   
   function showDetails(seqid,content_type,name,file) {
		
		// For others, open window to file or put in dialog? depends on size...
		$("#documentDetails" ).html('<p class="wait"><img title="loading" alt="loading" src="images/waiting.gif"/></p>');
	    $("#documentDetails" ).dialog({ title: 'Loading, please wait' , width : '200px' });
		if(content_type=="biosequence/gff") {
		  // Get gff doc from seqid
		  $.get($solrUrl+"q=seqid:"+seqid,
				   function(data){
				        $("#documentDetails" ).dialog( "close" );
			   			
			   			//data = '{"responseHeader":{"status":0,"QTime":30,"params":{"facet":"on","start":"0","q":"yeast","facet.field":"bank","qt":"shard","wt":"json"}},"response":{"numFound":1,"start":0,"docs":[{"bank":"yeast","chr":"chrI","feature":"region","attributes":"ID=FLO9","strand":".","id":"FLO9","stream_content_type":"biosequence/gff","stream_name":"/etc/gbrowse2/solrData/yeast/yeast.gff","seqid":"ebdf15f9-c3d8-42ff-b959-d22b3f68ec1f","start":[24001],"end":[27969]}]}}';
			   			var details="";
			   			var obj = jQuery.parseJSON(data);
			   			var doc = obj.response.docs[0];
			   			for(var key in doc) {
							if(key.indexOf('stream_')==-1 && key.indexOf('seqid')==-1 && key.indexOf('id')==-1 && key.indexOf('file')==-1) {
								if(key=="attributes") {
									//Split attributes
									var attr = doc[key].split(";");
									for(var attrkey in attr) {
								   	 	var attribute = attr[attrkey].split("=");
										details+='<div class="fieldDetail">'+attribute[0]+': '+$.URLDecode(attribute[1])+'</div>';	
									}
								}
								else {
									details+='<div class="fieldDetail">'+key+': '+$.URLDecode(doc[key])+'</div>';		
								}
							}
						} // end for
						if(name) {
							// If a link to original file is present, add it with a link for download.
							   var fileurl = '<a target="_blank" href="lookup.jsp?file='+$.URLEncode(name)+'&content-type='+content_type;
								if(file) {
		  							fileurl += "&position="+file;
								}
								fileurl += '">Genbank sheet</a>';
								details+='<div class="fieldDetail">'+fileurl+'</div>';
						}
			   			$("#documentDetails" ).html(details);
						$("#documentDetails" ).dialog({ title: 'Document' , width : '600px'  });
				   },"application/json"
				 );
		}
		else {
		var fileurl = "lookup.jsp?file="+$.URLEncode(name)+"&content-type="+content_type;
		if(file) {
		  fileurl += "&position="+file;
		}
		$.get(fileurl,
				   function(data){
				   $("#documentDetails" ).html(data);
				   $("#documentDetails" ).dialog({ title: 'Document' , width : '600px'  });
				   
		});
		
		}
		
	};
   
   function submitFacet(key,facet) {
   	$("input#query").val($("input#query").val()+" +"+key+":"+facet);
    doQuery($("input#query").val(),0);
   }
   
   function doQuery(solrQuery,start) {
   		$pageCount=1;
   		// Show loading windows
   		$("#documentDetails" ).html('<p class="wait"><img title="loading" alt="loading" src="images/waiting.gif"/></p>');
	    $("#documentDetails" ).dialog({ title: 'Loading, please wait...' , width : '200px'  });
   		
		$.get($solrUrl+$solrFacet+"q="+solrQuery+"&start="+start,
				   function(data){
				        $("#documentDetails" ).dialog( "close" );
			   			
			   			//data = '{"responseHeader":{"status":0,"QTime":30,"params":{"facet":"on","start":"0","q":"yeast","facet.field":"bank","qt":"shard","wt":"json"}},"response":{"numFound":16406,"start":0,"docs":[{"bank":"yeast","chr":"chrI","feature":"region","attributes":"ID=FLO9","strand":".","id":"FLO9","stream_content_type":"biosequence/gff","stream_name":"/etc/gbrowse2/solrData/yeast/yeast.gff","seqid":"ebdf15f9-c3d8-42ff-b959-d22b3f68ec1f","start":[24001],"end":[27969]},{"bank":"yeast","chr":"chrI","feature":"region","attributes":"ID=CLN3","strand":".","id":"CLN3","stream_content_type":"biosequence/gff","stream_name":"/etc/gbrowse2/solrData/yeast/yeast.gff","seqid":"c1ddd825-5618-418b-bab8-69a8d802bdf9","start":[65779],"end":[67521]},{"bank":"yeast","chr":"chrI","feature":"region","attributes":"ID=MAK16","strand":".","id":"MAK16","stream_content_type":"biosequence/gff","stream_name":"/etc/gbrowse2/solrData/yeast/yeast.gff","seqid":"9e2cf512-8253-4cd7-a92f-d0b04f073fed","start":[100226],"end":[101146]},{"bank":"yeast","chr":"chrI","feature":"region","attributes":"ID=CYS3","strand":".","id":"CYS3","stream_content_type":"biosequence/gff","stream_name":"/etc/gbrowse2/solrData/yeast/yeast.gff","seqid":"5954d8ed-d19c-4815-a99e-8e9a4d40fd88","start":[130802],"end":[131986]},{"bank":"yeast","chr":"chrI","feature":"region","attributes":"ID=ADE1","strand":".","id":"ADE1","stream_content_type":"biosequence/gff","stream_name":"/etc/gbrowse2/solrData/yeast/yeast.gff","seqid":"7cba9dcd-2b2d-43be-853d-0339697af694","start":[169370],"end":[170290]},{"bank":"yeast","chr":"chrI","feature":"region","attributes":"ID=PHO11","strand":".","id":"PHO11","stream_content_type":"biosequence/gff","stream_name":"/etc/gbrowse2/solrData/yeast/yeast.gff","seqid":"166f32b1-85b4-49d4-a614-26f8b0fb0ba1","start":[225451],"end":[226854]},{"bank":"yeast","chr":"chrII","feature":"region","attributes":"ID=ILS1","strand":".","id":"ILS1","stream_content_type":"biosequence/gff","stream_name":"/etc/gbrowse2/solrData/yeast/yeast.gff","seqid":"1d63704f-2c42-47cb-964c-e7650f7289f8","start":[81041],"end":[84259]},{"bank":"yeast","chr":"chrII","feature":"region","attributes":"ID=MCM2","strand":".","id":"MCM2","stream_content_type":"biosequence/gff","stream_name":"/etc/gbrowse2/solrData/yeast/yeast.gff","seqid":"db31a7e0-eec4-4a18-9c19-864fb8e2ea96","start":[174923],"end":[177529]},{"bank":"yeast","chr":"chrII","feature":"region","attributes":"ID=RAD16","strand":".","id":"RAD16","stream_content_type":"biosequence/gff","stream_name":"/etc/gbrowse2/solrData/yeast/yeast.gff","seqid":"19b55e74-f3d4-44c3-a177-385606a56987","start":[467242],"end":[469614]},{"bank":"yeast","chr":"chrII","feature":"region","attributes":"ID=SUP45","strand":".","id":"SUP45","stream_content_type":"biosequence/gff","stream_name":"/etc/gbrowse2/solrData/yeast/yeast.gff","seqid":"3cd53a52-6120-4a29-b60c-269889532941","start":[530863],"end":[532176]}]},"facet_counts":{"facet_queries":{},"facet_fields":{"bank":["yeast",16406]},"facet_dates":{}}}';
			   			
			   			var obj = jQuery.parseJSON(data);
			   			$("#metadata").html("Found "+obj.response.numFound+" documents");
			   			if(obj.facet_counts) {
			   			 showFacets(obj.facet_counts.facet_fields);
			   			}
			   			if(obj.response.docs) {
			   			 showResults(obj.response.docs);
			   			 showNavigation(obj.response.numFound);
			   			}
			   			//Add facets,content and links for navigation
				   },"application/json"
				 );
  }
	
  function showNavigation(nbdocs) {
  	
  	if(nbdocs/$pageCountResults>10) {
  		var nav="";
  		for(var i=1;i<=5;i++) {
  			nav += '<div class="nav" onclick="doQuery(\''+$("input#query").val()+'\','+((i-1)*$pageCountResults)+')">'+i+"</div>"; 	
  		}
  		nav += '<div class="nav">...';
  		nav += '<input type="text" name="gotopage" id="gotopage" size="4" value="" class="text-input"/>';
 		nav += '<button type="button" onclick="goToPage()">Go to page</button>';
  		nav += '...</div>';
  		
  		for(var i=Math.ceil(nbdocs/$pageCountResults)-5;i<=Math.ceil(nbdocs/$pageCountResults);i++) {
  			nav += '<div class="nav" onclick="doQuery(\''+$("input#query").val()+'\','+((i-1)*$pageCountResults)+')">'+i+"</div>"; 	
 		}
  		$("#navigation").html(nav); 	
  	}
  	else {
  		var nav="";
  		for(var i=1;i<=Math.ceil(nbdocs/$pageCountResults);i++) {
  			nav += '<div class="nav" onclick="doQuery(\''+$("input#query").val()+'\','+((i-1)*$pageCountResults)+')">'+i+"</div>"; 	
  		}
  		$("#navigation").html(nav);
  	}
  
  }
	
  function showFacets(facets) {
   var content = '<ul>';
   for(var key in facets) {
   		content += '<li class="facet">'+key+'</li><ul>';
   		size = facets[key].length;
   		for(s=0;s<size;s++) {
   			facetlist = facets[key];
			facet = facetlist.shift();
			if(facet) {
				content+='<li class="facet" onclick="submitFacet(\''+key+'\',\''+facet+'\')">'+facet;
			}
			facet = facetlist.shift();
			if(facet) {
				content+=" ("+facet+")</li>\n";
			}			
		}
		content+="</ul>";	
	}	
	content+="</ul>";
	$("#facets").html(content);
  }
  
  function showResults(docs) {
  	size = docs.length;
    var content = '';
    for(s=0;s<size;s++) {
		doc = docs.shift();
        var subclass = 'Odd';
        if(s%2==0) subclass= 'Even'
        content+='<div class="document'+subclass+'">';

		content+='<div class="doclinks">';
		content+='<img  onclick="showDetails(\''+doc["seqid"]+'\',\''+ doc["stream_content_type"] +'\',\''+ doc["stream_name"]  +'\',\''+ doc["file"]  +'\')" title="Show details" alt="Show details" src="images/ihelp.png" class="icon"/>';
			
		if(doc["stream_content_type"]=="biosequence/gff") { 
        	// NOSQL source
        	content+='<a  href="'+$storageurl+'/riak/web/dataquery.html?id='+doc['id']+'&source='+doc['chr']+'&start='+doc['start']+'&stop='+doc['end']+'" target="_blank"><img class="icon" title="Get source/transcript data" alt="Get raw data" src="images/iDocument.png"/></a>';
	    	// GBrowse
        	content+='<a href="'+$gburl+'/gb2/gbrowse/'+$gbbank+'?name='+doc['chr']+':'+doc['start']+'..'+doc['end']+'" target="_blank"><img class="icon" alt="Browse genome" title="Browse genome" src="images/ibrowse.png"/></a>'  
		 }
		 content+='</div>';
		
		for(var key in doc) {
		if(key.indexOf('stream_')==-1 && key.indexOf('seqid')==-1 && key.indexOf('id')==-1) {
		content+='<div class="field">'+key+': '+$.URLDecode(doc[key])+'</div>';		
		}
		}
	 
		content+='</div>\n';
		
	}
	
	$("#documents").html(content);
  
  }	
	

 </script>
 <title>SeqCrawler query</title>                                                               
 </head>                                                                 
 <body>
   <div id="header" class="query-box">
   <img src="images/crawlit_banner.png"/>
   <div id="query">
   <form id="queryForm" name="queryForm" action="">
   
   <label for="query" id="query_label">Query</label>
   <img  onclick="showFields()" title="List of fields" alt="List of fields" src="images/ihelp.png" class="icon"/>
   
   <input type="text" name="query" id="query" size="100" value="" class="text-input"/>
   <label class="error" for="query" id="query_error">This field is required.</label> 
   <input type="submit" name="submit" class="button" id="submit_button" value="Submit"/>
   </form>
   </div>
   </div>
   <div id="metadata"/>
   <p>This is the web interface to the data banks index.</p><p>Enter a compliant query to get results filtered by banks</p>
   <p>Example: "+bank:genbank +feature:rna" or "yeast" </p>
   </div>                                                                  
   <div id="content">
   <div id="results"><div id="documents"></div><div id="navigation"/></div></div>
   <div id="facets"></div>
   </div>
   <div id="footer"><hr width="70%"/>Powered by the GenOuest BioInformatics Plaform (http://www.genouest.org)</div>                                        
   <div id="documentDetails"/>
 </body>                                                                 
 </html>
